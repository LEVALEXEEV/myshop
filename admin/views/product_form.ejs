<%- include('partials/_head', { title: mode === 'create' ? 'Новый товар' : 'Редактирование товара' }) %>
<%- include('partials/_nav', { csrfToken, active: 'products' }) %>

<div class="page">

  <!-- Breadcrumb -->
  <div class="breadcrumb">
    <a href="/products">Товары</a>
    <span class="breadcrumb__sep">/</span>
    <span><%= mode === 'create' ? 'Новый товар' : product.title %></span>
  </div>

  <!-- Page header -->
  <div class="page-header">
    <div>
      <div class="page-header__title">
        <%= mode === 'create' ? 'Новый товар' : `Редактирование товара #${product.id}` %>
      </div>
    </div>
    <% if (mode === 'edit') { %>
      <a href="/products/<%= product.id %>/stock" class="btn btn-ghost">Управление складом</a>
    <% } %>
  </div>

  <!-- Main form -->
  <form method="post" action="<%= mode === 'create' ? '/products' : `/products/${product.id}` %>">
    <input type="hidden" name="_csrf" value="<%= csrfToken %>" />

    <div class="form-grid">

      <!-- Left column: basic info -->
      <div style="display:flex;flex-direction:column;gap:16px">
        <div class="card">
          <div class="card__header">Основная информация</div>
          <div class="card__body" style="display:flex;flex-direction:column;gap:14px">

            <div class="form-group">
              <label for="f-title">Название <span class="text-danger">*</span></label>
              <input id="f-title" class="form-control" name="title" value="<%= product.title ?? '' %>" required />
            </div>

            <div class="form-grid" style="grid-template-columns:1fr 1fr;gap:12px">
              <div class="form-group">
                <label for="f-price">Цена, ₽ <span class="text-danger">*</span></label>
                <input id="f-price" class="form-control" name="price" type="number" min="0" step="1" value="<%= product.price ?? 0 %>" required />
              </div>
              <div class="form-group">
                <label for="f-category">Категория</label>
                <input id="f-category" class="form-control" name="category" value="<%= product.category ?? '' %>" />
              </div>
            </div>

            <div class="form-check">
              <input id="f-sold-out" name="sold_out" type="checkbox" <%= product.sold_out ? 'checked' : '' %> />
              <label for="f-sold-out">Нет в наличии (sold out)</label>
            </div>

          </div>
        </div>

        <!-- Images -->
        <div class="card">
          <div class="card__header">Изображения</div>
          <div class="card__body" style="display:flex;flex-direction:column;gap:14px">
            <div class="alert alert-info" style="margin-bottom:0">
              Пути вида <code>/images/products/your-file.webp</code>
            </div>

            <div class="form-group">
              <label for="f-image">Основное фото <span class="text-danger">*</span></label>
              <input id="f-image" class="form-control" name="image" value="<%= product.image ?? '' %>" required />
            </div>

            <div class="form-group">
              <label for="f-image-hover">Фото при наведении</label>
              <input id="f-image-hover" class="form-control" name="image_hover" value="<%= product.image_hover ?? '' %>" />
            </div>

            <div class="form-group">
              <label for="f-size-chart">Таблица размеров</label>
              <input id="f-size-chart" class="form-control" name="size_chart" value="<%= product.size_chart ?? '' %>" />
            </div>

            <div class="form-group">
              <label for="f-extra">Дополнительные фото <span class="form-hint">(по одному на строку)</span></label>
              <textarea id="f-extra" class="form-control" name="extra_images_text"><%= product.extra_images_text ?? '' %></textarea>
            </div>

            <% if (product.image) { %>
              <div class="img-preview-grid">
                <div class="img-preview-item">
                  <span>Основное</span>
                  <img src="<%= product.image %>" alt="main" />
                </div>
                <% if (product.image_hover) { %>
                <div class="img-preview-item">
                  <span>Наведение</span>
                  <img src="<%= product.image_hover %>" alt="hover" />
                </div>
                <% } %>
              </div>
            <% } %>
          </div>
        </div>
      </div>

      <!-- Right column: description -->
      <div style="display:flex;flex-direction:column;gap:16px">
        <div class="card" style="flex:1">
          <div class="card__header">Описание</div>
          <div class="card__body">
            <div class="form-group">
              <label for="f-desc">Текст описания <span class="form-hint">(HTML поддерживается)</span></label>
              <textarea id="f-desc" class="form-control" name="description" style="min-height:260px"><%= product.description ?? '' %></textarea>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="form-actions">
      <button type="submit" class="btn btn-primary"><%= mode === 'create' ? 'Создать товар' : 'Сохранить изменения' %></button>
      <a href="/products" class="btn btn-neutral">Отмена</a>
    </div>
  </form>

  <!-- Upload -->
  <% if (mode === 'edit') { %>
  <div class="card mt-6">
    <div class="card__header">Загрузка изображения</div>
    <div class="card__body">
      <form method="post" action="/upload" enctype="multipart/form-data">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
        <input type="hidden" name="productId" value="<%= product.id %>" />

        <div class="form-grid" style="gap:12px">
          <div class="form-group">
            <label>Папка</label>
            <select class="form-control" name="folder">
              <option value="products">products</option>
              <option value="size-charts">size-charts</option>
            </select>
          </div>

          <div class="form-group">
            <label>Установить в поле</label>
            <select class="form-control" name="field">
              <option value="image">Основное фото</option>
              <option value="image_hover">Фото при наведении</option>
              <option value="size_chart">Таблица размеров</option>
              <option value="extra_images">Доп. фото (добавить)</option>
            </select>
          </div>

          <div class="form-group">
            <label>Имя файла (базовое)</label>
            <input class="form-control" name="baseName" value="product-<%= product.id %>" />
          </div>

          <div class="form-group">
            <label>Файл <span class="text-danger">*</span></label>
            <input class="form-control" name="file" type="file" accept="image/*" required style="padding:6px" />
          </div>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn btn-primary">Загрузить и применить</button>
        </div>
      </form>
    </div>
  </div>
  <% } %>

  <!-- Delete -->
  <% if (mode === 'edit') { %>
  <div class="card mt-4" style="border-color:#fca5a5">
    <div class="card__header" style="color:var(--clr-danger)">Опасная зона</div>
    <div class="card__body" style="display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap">
      <div>
        <div style="font-weight:500">Удалить товар</div>
        <div class="form-hint">Это действие необратимо. Товар будет удалён из базы данных.</div>
      </div>
      <form method="post" action="/products/<%= product.id %>/delete"
            onsubmit="return confirm('Удалить товар «<%= product.title %>»? Это действие нельзя отменить.')">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
        <button class="btn btn-danger-ghost" type="submit">Удалить товар</button>
      </form>
    </div>
  </div>
  <% } %>

</div>
</body>
</html>
